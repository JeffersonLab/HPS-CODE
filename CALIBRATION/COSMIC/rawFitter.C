/*In root,
 *run as .L rawFitter.C++
 *then fitPulse(xx,yy)
 *where xx,yy are array indices 
 */

// Tune-able parameters:
#define MINS 35 
#define MAXS 55
//pedestal window
#define MINP 10
#define MAXP 30
// difference in window
#define NWIN 20
//threshold in mV
#define THR 3.5 
#define NSAMPINT 20
/////////////////////
// Don't change these:
#define NX 46
#define NY 10
#define NSAMP 100
#define NR 11
#define ADC2V 0.25
////////////////////


#include "TH1.h"
#include "TNtuple.h"
#include "TPad.h"
#include "TTree.h"
#include "TMath.h"
#include "TStyle.h"
#include "TLegend.h"
#include "TDirectory.h"
#include "TF1.h"
#include "TPaveText.h"
#include "dependency/chainfilelist.C"
#include "dependency/MyRootUtil.C"
#include "dependency/ProgressMeter.C"
#include "dependency/langaus.C"
#include "dependency/functions.C"

//initialize the widths
const double threePoleWidths[442]={
  2.44057,2.40057,2.53389,2.32095,2.44267,2.43631,2.40292,2.46911,2.36032,2.42132,2.41473,2.43864,2.37710,2.43278,2.49126,2.41739,2.40560,
  2.42042,2.51278,2.46731,2.42647,2.35636,2.55308,2.47517,2.38748,2.48324,2.53726,2.54780,2.50771,2.45188,2.35011,2.35110,2.37575,2.37649,
  2.41037,2.38817,2.52422,2.47389,2.40672,2.59415,2.35626,2.44359,2.54118,2.42893,2.43100,2.32748,2.34831,2.30641,2.40003,2.38997,2.41643,
  2.45717,2.44830,2.48149,2.44339,2.33572,2.42276,2.43731,2.44205,2.37290,2.54975,2.44517,2.39132,2.48821,2.45687,2.39768,2.61674,2.52142,
  2.46620,2.46802,2.54764,2.45238,2.48421,2.44521,2.47204,2.50415,2.47346,2.51053,2.44811,2.54895,2.44839,2.51419,2.45706,2.38596,2.46743,
  2.49971,2.37904,2.46478,2.43015,2.52088,2.55846,2.50522,2.30973,2.41450,2.40907,2.31343,2.48668,2.46800,2.43559,2.42113,2.47494,2.36971,
  2.44022,2.44193,2.42661,2.41918,2.41102,2.51565,2.34875,2.36750,2.37355,2.48763,2.36659,2.42424,2.44321,2.46651,2.52053,2.46172,2.41316,
  2.41670,2.41661,2.53472,2.49345,2.46496,2.40006,2.41084,2.44442,2.49113,2.42821,2.56839,2.45630,2.46344,2.42585,2.43730,2.44339,2.44315,
  2.48069,2.39892,2.36987,2.40482,2.40103,2.36307,2.46118,2.47136,2.39327,2.46267,2.30668,2.45917,2.46903,2.51727,2.27056,2.46365,2.35228,
  2.52188,2.44052,2.41457,2.25591,2.51210,2.43585,2.57410,2.46877,2.37902,2.46975,2.45628,2.44264,2.36588,2.48233,2.46351,2.37512,2.44228,
  2.52664,2.51927,2.37348,2.52284,2.52505,2.55755,2.51522,2.44848,2.51430,2.41387,2.42311,2.42880,2.46546,2.40000,2.45992,2.46841,2.43101,
  2.22369,2.43262,2.41324,2.45465,2.40752,2.50491,2.45191,2.40109,2.49099,2.37011,2.70111,2.46843,2.44336,2.44675,2.42308,2.51800,2.45660,
  2.43406,2.43297,2.37133,2.50718,2.43035,2.42818,2.47709,2.40578,2.39228,2.47350,2.51876,2.39584,2.44114,2.49120,2.48185,2.59246,2.41612,
  2.42914,2.51496,2.38785,2.53339,2.30056,2.25807,2.40500,2.53300,2.37439,2.48418,2.33764,2.47934,2.33080,2.48834,2.48318,2.42860,2.28253,
  2.44013,2.38272,2.23632,2.37630,2.34564,2.34538,2.44281,2.33952,2.33574,2.40939,2.44992,2.43986,2.45022,2.39336,2.43253,2.38136,2.41941,
  2.56685,2.54684,2.43060,2.33258,2.43024,2.48895,2.51698,2.38837,2.45276,2.38518,2.35826,2.38321,2.31616,2.46480,2.53753,2.28027,2.50727,
  2.35369,2.29179,2.06776,2.49429,2.35639,2.42628,2.55657,2.51859,2.49579,2.45617,2.41293,2.47083,2.51653,2.47478,2.46354,2.48828,2.34846,
  2.34419,2.43172,2.46589,2.45462,2.52146,2.35946,2.38810,2.46027,2.53848,2.48102,2.42701,2.51750,2.57911,2.45136,2.48329,2.39329,2.48209,
  2.35948,2.49431,2.36117,2.26121,2.40899,2.51383,2.41642,2.52102,2.39702,2.43949,2.40867,2.38560,2.46874,2.22937,2.40741,2.36007,2.38784,
  2.41052,2.42673,2.39476,2.40239,2.46902,2.55278,2.44661,2.54734,2.41863,2.42451,2.40056,2.44307,2.35066,2.46254,2.43270,2.50439,2.49733,
  2.55563,2.48589,2.45219,2.44774,2.41116,2.49081,2.43893,2.43731,2.55774,2.42404,2.37911,2.45140,2.47196,2.50533,2.38292,2.47868,2.48262,
  2.39845,2.42290,2.54415,2.43109,2.54306,2.49385,2.35113,2.43233,2.50552,2.49532,2.42667,2.53772,2.41398,2.41968,2.59536,2.52077,2.42026,
  2.51269,2.42584,2.54930,2.63547,2.42869,2.43348,2.42402,2.38768,2.41903,2.50153,2.45315,2.45472,2.41113,2.44795,2.50849,2.41817,2.44166,
  2.61143,2.38567,2.40737,2.39843,2.43711,2.35324,2.48315,2.38388,2.45665,2.30220,2.41293,2.36640,2.38185,2.40913,2.49233,2.46818,2.51527,
  2.54177,2.37051,2.37318,2.38405,2.53258,2.58176,2.53786,2.52385,2.40308,2.45279,2.39370,2.50056,2.41076,2.40789,2.47444,2.52857,2.40741,
  2.38524,2.39403,2.42442,2.56829,2.56063,2.58340,2.42897,2.58796,2.56262,2.53480,2.43707,2.38258,2.46584,2.40596,2.42590,2.48281,2.47800
};

//fitting function
Double_t fitpk(Double_t *x,Double_t *par){
  //par0 = pedestal
  //par1 = integral
  //par2 = width
  //par3 = t0

  return (x[0]<par[3])*par[0]
    +(x[0]>=par[3])*(par[0]
		     +par[1]/pow(par[2],3)/2
		     *pow(x[0]-par[3],2)
		     *exp(-(x[0]-par[3])/par[2]));
}



//Draws raw adc readout for x,y crystal
void fitPulse(const int ix,const int iy)
{
  int kk=0;
  if (ix<0 || iy<0 || ix>=NX || iy>=NY) { cerr<<"What? "<<ix<<" "<<iy<<endl;return;}
  TChain *t=chainfiledir("input","Tadc");
  fadc_t t_;
  InitTreeFADC((TTree*)t,t_);
  TH1D *h=new TH1D("h","",NSAMP,-0.5,NSAMP-0.5);
  const bool doped=0;
  for (int ii=0; ii<t->GetEntries(); ii++)
    {
      t->GetEntry(ii);
      int trigger=0;
      double pulseIntegral = 0;
      int time0 = 0;
      double pedestal = 0;
      
      //loop over ADC samples
      for (int jj=0; jj<NSAMP; jj++)
        {
	  const int adc=t_.adc[ix][iy][jj];
	  float ped = 0;
	  for (int ii=0; ii<30; ii++){
	    ped +=t_.adc[ix][iy][ii];
	  }
	  //calculate the average pedestal
	  pedestal=ped/30;
	  //calculate the pulse integral
	  if (jj>MINS && jj<MAXS){
	    pulseIntegral+=(adc-pedestal)*ADC2V;
	  }
	  //look for a threshold crossing
	  if (jj>30 && (adc-pedestal)*ADC2V>THR && jj<50)
	    {
	      trigger=1;
	      time0=jj;     
	    }
	  if (doped) h->SetBinContent(jj+1,(adc-pedestal)*ADC2V);
	  else       h->SetBinContent(jj+1,adc*ADC2V);
	}           
      if (trigger==1){
	h->Draw();
	//set the fit parameters
	double rangeMin = MINS-5;
	double rangeMax = MAXS+5;
	TF1 *pFit = new TF1("pFit",fitpk,rangeMin,rangeMax,4);
	pFit->SetLineColor(kRed);
	int dbid = xy2dbid(ix,iy);
	pFit->SetParameters(pedestal,pulseIntegral,threePoleWidths[dbid-1],time0-2);
	pFit->SetParNames("ped","integral","width","t_{thr}");

	//set parameter limits
	pFit->SetParLimits(1,0,999999);
	pFit->SetParLimits(2,0.1,5);
	pFit->SetParLimits(3,rangeMin+5,rangeMax-5);

	//fit the distribution
	h->Fit(pFit,"QMR","",rangeMin,rangeMax);
	pFit->Draw("lsame");
	
	gStyle->SetOptFit(11111);	
	gPad->Update();
	gPad->SaveAs(Form("%d.C",kk));
	kk++;     
	if (getchar()=='q') return;
      }//end trigger

    }//end loop entries
}//end fitpulse






